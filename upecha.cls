%% start of file `upecha.cls'.
%% Copyright 2010-2014 by Elie Roux <elie.roux@telecom-bretagne.eu>
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the CC0 Public license, see
% http://creativecommons.org/publicdomain/zero/1.0/legalcode.
%
%
% The code is a rewriting of pecha.cls from Dieter JÃ¤ger, with the following
% apdatations:
%  - Unicode tibetan
%  - fixing a mistake on the number twenty
%  - adding a lua module for numbers
%  - a few fixes in the output routine
%  - backgrounds are not generated by TeX but are included in the PDF
%  - simplifying a lot the layout code and making it more flexible
%  - adding an optional argument to the headers to set them rotated or not.

\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{upecha}[2014/09/21 v0.8 tibetan modern pecha class]

\newcommand\@ptsize{}
\DeclareOption{10pt}{\renewcommand\@ptsize{0}}
\DeclareOption{11pt}{\renewcommand\@ptsize{1}}
\DeclareOption{12pt}{\renewcommand\@ptsize{2}}

% draft/final option
\DeclareOption{draft}{\setlength\overfullrule{5pt}}
\DeclareOption{final}{\setlength\overfullrule{0pt}}

% execute default options
\ExecuteOptions{11pt,final}

% process given options
\ProcessOptions\relax

% paper size (make an option?)
\setlength\paperwidth {297mm}
\setlength\paperheight{105mm}

\input{size1\@ptsize.clo}

\@lowpenalty   51
\@medpenalty  151
\@highpenalty 301

\RequirePackage{eso-pic}
\RequirePackage{graphicx}
\RequirePackage{rotating}

\newlength\@rulers

\setlength\pdfpagewidth{\paperwidth}
\setlength\pdfpageheight{\paperheight}

\RequirePackage{luatexbase}

\RequireLuaModule{upecha}

\def\tibnumeral#1{%
  \directlua{tex.print(upecha.totibnumber([[#1]]))}%
}

\newcount{\@pechacnt}
\newlength{\@marginht}
\newlength{\@margintotal}
\newlength{\@margindp}
\newlength{\@margindptib}
\newlength{\@margincenterbegin}
\newlength{\@margincenterwidth}
\newlength{\@marginaftercenter}

\newcounter{pechasheet}
\setcounter{pechasheet}{\@ne}

\textwidth\paperwidth
\headheight 0pt
\headsep 0pt
\marginparsep 0pt
\marginparwidth 0pt
\footskip 0pt
\marginparpush 0pt
\oddsidemargin -1in % meaning 0 in fact
\evensidemargin -1in

% TODO: option
\global\textheight 77mm
\global\vsize\textheight
\global\topmargin-0.5\textheight
\global\advance\topmargin by 0.5\paperheight
\global\advance\topmargin by - 1in

% the main layout function
% #1 is the width between the border and the margin text baseline in case of rotated margin text
% #2 is the width between the border and the margin text baseline in case of rotated tibetan text
% #3 is the width between the border and the start of the box where to center margin text in case of non-rotated margin text
% #4 is the width of the box where to center margin text in case of non-rotated margin text
% #5 is the total margin width
% #6 is the textheight
% #7 is the image to put in the background
\def\pechasetlayout#1#2#3#4#5#6{%
  \newpage %
  \global\@margindp #1%
  \global\@marginht #5%
  \global\advance\@marginht by -\@margindp %
  \global\@margincenterbegin #3%
  \global\@margincenterwidth #4%
  \global\@marginaftercenter=#5%
  \global\advance\@marginaftercenter by -\@margincenterbegin %
  \global\advance\@marginaftercenter by -\@margincenterwidth %
  \global\textwidth\paperwidth %
  \global\advance\textwidth by - 2\@marginht %
  \global\advance\textwidth by - 2\@margindp %
  \global\hsize\textwidth %
  \global\linewidth\textwidth %
  \global\pechasetbackground{#6}%
}

\def\pechasetbackground#1{%
  \ClearShipoutPicture{}%
  \AddToShipoutPicture{%
    \setlength{\@tempdimb}{.5\paperwidth}%
    \setlength{\@tempdimc}{.5\paperheight}%
    \setlength{\unitlength}{1pt}%
    \put(\strip@pt\@tempdimb,\strip@pt\@tempdimc){%
    \makebox(0,0){\includegraphics{#1}}%
    }%
  }%
}

\def\pechatitle#1#2{%
  \pechatitlelayout %
  \setbox\@obox=\hbox{#2}%
  \begin{center}%
  \setbox\@pbox\hbox{#1}%
  \ht\@pbox=\ht\@obox %
  \dp\@pbox=\dp\@obox %
  \leavevmode %
  \vbox to \textheight{\vss\box\@pbox\vss}%
  \end{center}%
}

\newcommand{\pechavcenter}[2][0pt]{
  \leavevmode\vbox to \textheight{%
    \vss %
    \parbox{\textwidth}{#2}%
    \vskip #1%
    \vss}%
}

\def\bispage{%
   \directlua{upecha.bispage("\the\c@page")}%
}

\def\pechanormallayout{%
  \pechasetlayout{1.85cm}{1.85cm}{1.65cm}{7.8mm}{2.9cm}{background1.pdf}%
}

\def\pechatitlelayout{%
  \pechasetlayout{3.2cm}{3.2cm}{2.7cm}{2.95cm}{7.1cm}{background3.pdf}%
}

\def\pechaintrolayout{%
  \pechasetlayout{1.9cm}{1.9cm}{1.65cm}{7.8mm}{6.05cm}{background2.pdf}%
}

\pechanormallayout

\pagenumbering{arabic}
%\sloppy

\parindent=0pt
\parskip12pt

% Some dimensons I will need
\newbox\@pbox
\newbox\@obox

% Macros to create the right and left margin texts
\def\@oleft{}
\def\@oleftrotate{0}
\def\@eleft{}
\def\@eleftrotate{0}
\def\@eright{}
\def\@erightrotate{0}
\def\@oright{}
\def\@orightrotate{0}
\def\@oddright{}
\def\@evenright{}
\def\@evenleft{}
\def\@oddleft{}
\def\@theleft{}
\def\@theright{}

\newcommand{\oddleft}[2][1]{\gdef\@oleftrotate{#1}\gdef\@oleft{#2}}
\newcommand{\oddright}[2][0]{\gdef\@orightrotate{#1}\gdef\@oright{#2}}
\newcommand{\evenleft}[2][1]{\gdef\@eleftrotate{#1}\gdef\@eleft{#2}}
\newcommand{\evenright}[2][0]{\gdef\@erightrotate{#1}\gdef\@eright{#2}}

% ignore standard chapter marks
\newcommand{\paragraph}[1]{}
\newcommand{\subparagraph}[1]{}
\newcommand{\section}[1]{\medskip}
\newcommand{\subsection}[1]{}
\newcommand{\subsubsection}[1]{}
\newcommand{\chapter}[1]{\bigskip}
\newcommand{\part}[1]{\bigskip}

\newcommand{\newsheet}{\clearpage\ifodd\c@page\else
    \hbox{}\newpage\fi}

% The left "header" on odd pages
\def\@oddleft{%
  \ifnum\@oleftrotate=1%
    \setbox\@pbox\hbox to \textheight{%
          \hss\@oleft\hss %
        }%
    \ht\@pbox=\@marginht %
    \dp\@pbox=\@margindp %
    \begin{turn}{-90}%
      \kern-\textheight\box\@pbox %
    \end{turn}%
  \else %
    \setbox\@pbox\hbox{%
      \kern\@margincenterbegin %
      \hbox to \@margincenterwidth{\hss\@oleft\hss}%
      \kern\@marginaftercenter %
    }%
    %\hbox{\vrule width 2mm height \vsize}
    %\raise 9cm\hbox{\vrule width 4mm height -\topmargin}%
    \@tempdimb=0.5\vsize %
    \advance\@tempdimb by -0.5\ht\@pbox %
    %\@tempdimb %
    \raise\@tempdimb\box\@pbox %
  \fi %
}

% the left "header" on even pages
\def\@evenleft{%
  \ifnum\@eleftrotate=1%
    \setbox\@pbox\hbox to \textheight{%
          \hss\@eleft\hss %
        }%
    \ht\@pbox=\@marginht %
    \dp\@pbox=\@margindp %
    \begin{turn}{-90}%
      \kern-\textheight\box\@pbox %
    \end{turn}%
  \else %
    \setbox\@pbox\hbox{%
      \kern\@margincenterbegin %
      \hbox to \@margincenterwidth{\hss\@eleft\hss}%
      \kern\@marginaftercenter %
    }%
    \@tempdima=0.5\textheight %
    \advance\@tempdima by -0.5\ht\@pbox %
    \raise \@tempdima\box\@pbox %
  \fi %
}

% The right "header" on odd pages
\def\@oddright{%
  \ifnum\@orightrotate=1%
    \setbox\@pbox\hbox to \textheight{%
        \hss\@oright\hss}%
    \ht\@pbox=\@marginht %
    \dp\@pbox=\@margindp %
    \begin{turn}{90}%
      \box\@pbox %
    \end{turn}%
  \else %
    \setbox\@pbox\hbox{%
      \kern\@marginaftercenter %
      \hbox to \@margincenterwidth{\hss\@oright\hss}%
      \kern\@margincenterbegin %
    }%
    \@tempdima=0.5\textheight %
    \advance\@tempdima by -0.5\ht\@pbox %
    \raise \@tempdima\box\@pbox %
  \fi %
}

% The right "header" on even pages
\def\@evenright{%
  \ifnum\@erightrotate=1%
    \setbox\@pbox\hbox to \textheight{%
        \hss\@eright\hss}%
    \ht\@pbox=\@marginht %
    \dp\@pbox=\@margindp %
    \begin{turn}{90}%
      \box\@pbox %
    \end{turn}%
  \else %
    \setbox\@pbox\hbox{%
      \kern\@marginaftercenter %
      \hbox to \@margincenterwidth{\hss\@eright\hss}%
      \kern\@margincenterbegin %
    }%
    \@tempdima=0.5\textheight %
    \advance\@tempdima by -0.5\ht\@pbox %
    \raise \@tempdima\box\@pbox %
  \fi %
}

\def\@pechaframe#1{%
  \hbox{%
    \vbox{%
      \hbox{%
        \@theleft % left box content
        \vbox{%
          \box#1%
        }%
        \@theright %
      }%
    }%
  }%
}

\makeatletter
\def\@outputpage{\pecha@outputpage}

\def\pecha@outputpage{%
  \begingroup %
    \set@typeset@protect % otherwise fonts cannot be changed here
    \reset@font %
    \normalsize %
    \normalsfcodes %
    \@parboxrestore %
    \let\protect\noexpand %
    \@resetactivechars %
    % a hack for empty pages: These need to be framed properly
    \ifodd\count\z@ %
         \let\@themargin\oddsidemargin %
    \else %
         \let\@themargin\evensidemargin %
      \fi %
    \setbox\@outputbox\vbox{\hfil\box\@outputbox\hfil}%
    \ifodd\c@page %
      \let\@theleft\@oddleft %
      \let\@theright\@oddright %
      \setbox\@outputbox\hbox{\@pechaframe{\@outputbox}}%
    \else %
      \let\@theleft\@evenleft %
      \let\@theright\@evenright %
      \setbox\@outputbox\hbox{\@pechaframe{\@outputbox}}%
      \stepcounter{pechasheet}%
    \fi %
    \shipout\vbox{%
      \set@typeset@protect %
      \aftergroup \endgroup %
      \aftergroup \set@typeset@protect %
      \let\label\@gobble %
      \let\index\@gobble %
      \let\glossary\@gobble %
      \baselineskip \footskip %
      \@begindvi %
      \vskip \topmargin %
      \moveright\@themargin %
      \box\@outputbox %
    }%
  \stepcounter{page}%
}
\makeatother

\endinput

